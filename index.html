<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>UsTrip Â· æ—…è¡ŒåŠ©æ‰‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5fb;
      --card-bg: #ffffff;
      --primary: #6366f1;
      --primary-soft: #e0e7ff;
      --accent: #f97373;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe, #f9fafb 40%),
        radial-gradient(circle at bottom right, #e0e7ff, #f9fafb 50%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }

    header.app-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      position: sticky;
      top: 10px;
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-badge {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, #fee2e2, #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
    }

    .logo-text-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .logo-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .logo-text-wrapper {
      display: flex;
      flex-direction: column;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      border-radius: 999px;
      padding: 6px 12px;
      background: var(--primary-soft);
      color: #4338ca;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip span.label {
      font-weight: 600;
    }

    .chip button {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      color: inherit;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #111827;
      color: #f9fafb;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-main);
    }

    .btn-sm {
      padding: 4px 9px;
      font-size: 11px;
    }

    .btn:active {
      transform: translateY(1px);
    }

    main {
      margin-top: 16px;
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
      header.app-header {
        border-radius: 20px;
      }
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      padding: 14px 16px 16px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(229, 231, 235, 0.8);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.emoji {
      font-size: 18px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 9px;
      background: #f3f4ff;
      color: #4f46e5;
    }

    .pill-muted {
      background: #f3f4f6;
      color: #6b7280;
    }

    .day-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0 4px;
    }

    .day-chip {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      background: #f3f4ff;
      color: #4b5563;
    }

    .day-chip.active {
      background: #6366f1;
      color: #f9fafb;
      border-color: #4f46e5;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .summary-row span strong {
      color: var(--text-main);
    }

    .itinerary-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .it-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      position: relative;
    }

    .it-time {
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
      min-width: 40px;
      padding-top: 2px;
    }

    .it-main {
      font-size: 13px;
    }

    .it-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
    }

    .it-title {
      font-weight: 600;
    }

    .it-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      white-space: nowrap;
    }

    .it-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .it-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      align-items: center;
    }

    .it-meta {
      font-size: 11px;
      color: #6b7280;
    }

    .it-actions {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }

    .badge-distance {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
    }

    .section-divider {
      margin: 10px 0 6px;
      height: 1px;
      background: linear-gradient(to right, transparent, #e5e7eb, transparent);
    }

    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      align-items: center;
    }

    .form-inline input,
    .form-inline select {
      padding: 4px 7px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      min-width: 0;
    }

    .form-inline input.short {
      width: 64px;
    }

    .form-inline input.medium {
      width: 110px;
    }

    .form-inline input.long {
      flex: 1 1 150px;
    }

    .form-inline textarea {
      font-size: 11px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 5px 7px;
      width: 100%;
      resize: vertical;
      min-height: 40px;
      background: #f9fafb;
    }

    .subtle-label {
      font-size: 11px;
      color: #6b7280;
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 8px;
      margin-top: 4px;
    }

    @media (max-width: 600px) {
      .two-column {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .checklist-section {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 9px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .check-item input[type="checkbox"] {
      margin-top: 1px;
    }

    .check-item span.text {
      flex: 1;
    }

    .check-item.done span.text {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .favorites-list {
      margin-top: 6px;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-right: 4px;
    }

    .fav-item {
      font-size: 12px;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .fav-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .fav-name {
      font-weight: 600;
    }

    .fav-type-pill {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      white-space: nowrap;
    }

    .fav-sub {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 3px;
    }

    .fav-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .muted-link {
      font-size: 11px;
      color: #4b5563;
      text-decoration: none;
      border-bottom: 1px dashed #d1d5db;
    }

    .muted-link:hover {
      color: #111827;
    }

    .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
    }

    .small-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 3px;
    }

    .exchange-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
      font-size: 12px;
    }

    .exchange-row input {
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      width: 90px;
    }

    .exchange-result {
      font-size: 12px;
      color: #4b5563;
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ecfeff;
      color: #0369a1;
      margin-left: 4px;
    }

    .scroll-fade {
      position: relative;
    }

    .scroll-fade::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 14px;
      pointer-events: none;
      background: linear-gradient(to bottom, transparent, rgba(249, 250, 251, 0.9));
    }

    .text-link-button {
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      font-size: 11px;
      color: #4b5563;
      cursor: pointer;
      border-bottom: 1px dashed #d1d5db;
    }

    .text-link-button:hover {
      color: #111827;
    }

    .tiny {
      font-size: 10px;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="logo">
      <div class="logo-badge">U</div>
      <div class="logo-text-wrapper">
        <div class="logo-text-title">UsTrip</div>
        <div class="logo-text-sub" id="trip-subtitle">
          æˆ‘ä»¬çš„å°æ¹¾æ—…è¡Œ
        </div>
      </div>
    </div>
    <div class="header-right">
      <div class="chip">
        <span class="label" id="exchange-display">
          1 TWD â‰ˆ 0.15 MYR
        </span>
        <button id="btn-edit-exchange" title="ä¿®æ”¹æ±‡ç‡">âœï¸</button>
      </div>
      <button class="btn btn-outline btn-sm" id="btn-edit-trip">
        âœ¨ ç¼–è¾‘è¡Œç¨‹ä¿¡æ¯
      </button>
    </div>
  </header>

  <main>
    <!-- å·¦ä¾§ï¼šè¡Œç¨‹ + æ”¶è—åœ°ç‚¹ -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="emoji">ğŸ—ºï¸</span>
            <span>è¡Œç¨‹æ€»è§ˆ & æ¯æ—¥å®‰æ’</span>
          </div>
          <div class="card-subtitle" id="trip-summary">
            è¿˜æ²¡è®¾ç½®æ—¥æœŸ Â· å…± 0 å¤©
          </div>
          <div class="pill-row" id="city-overview">
            <!-- è‡ªåŠ¨å¡«å……åŸå¸‚æ¦‚è§ˆ / æ ‡ç­¾ -->
          </div>
        </div>
      </div>

      <div>
        <div class="day-selector" id="day-selector">
          <!-- Day tag buttons -->
        </div>
        <div class="summary-row" id="day-summary">
          <!-- å½“å‰æ—¥æœŸ / åŸå¸‚ / é¡¹ç›®æ•° -->
        </div>
      </div>

      <div class="section-divider"></div>

      <div>
        <div class="card-title" style="font-size: 13px; margin-bottom: 4px;">
          <span class="emoji">ğŸ“…</span>
          <span id="itinerary-title">ä»Šæ—¥è¡Œç¨‹</span>
        </div>
        <div class="card-subtitle">
          ç‚¹å‡»ã€Œåœ°å›¾ã€å³å¯è·³è½¬åˆ° Google Maps Â· åŒæ—¥åœ°ç‚¹è‡ªåŠ¨è®¡ç®—è·ç¦»
        </div>

        <div class="itinerary-list scroll-fade" id="itinerary-list"></div>

        <div class="section-divider"></div>

        <div>
          <div class="card-title" style="font-size: 13px; margin-bottom: 4px;">
            <span class="emoji">â•</span>
            <span>æ–°å¢è¡Œç¨‹é¡¹ç›®</span>
          </div>
          <div class="form-inline">
            <span class="subtle-label">æ—¶é—´</span>
            <input id="input-time" type="time" class="short" />

            <span class="subtle-label">ç±»å‹</span>
            <select id="input-type">
              <option value="poi">æ™¯ç‚¹</option>
              <option value="food">ç¾é£Ÿ</option>
              <option value="hotel">ä½å®¿</option>
              <option value="transport">äº¤é€š</option>
              <option value="other">å…¶ä»–</option>
            </select>

            <span class="subtle-label">æ ‡é¢˜</span>
            <input id="input-title" type="text" class="medium" placeholder="ä¾‹å¦‚ï¼šè¥¿é—¨ç”º / é¥¶æ²³å¤œå¸‚" />
          </div>
          <div class="form-inline" style="margin-top: 4px;">
            <span class="subtle-label">åœ°å€</span>
            <input id="input-address" type="text" class="long" placeholder="å¯é€‰ï¼Œæ–¹ä¾¿å¯¼èˆª" />
          </div>
          <div class="form-inline" style="margin-top: 4px;">
            <span class="subtle-label">åœ°å›¾é“¾æ¥</span>
            <input id="input-map" type="text" class="long" placeholder="ç²˜è´´ Google Maps åˆ†äº«é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
          </div>
          <div class="form-inline" style="margin-top: 4px;">
            <span class="subtle-label">ç»çº¬åº¦</span>
            <input id="input-lat" type="number" step="0.000001" class="medium" placeholder="çº¬åº¦ lat" />
            <input id="input-lng" type="number" step="0.000001" class="medium" placeholder="ç»åº¦ lng" />
            <span class="tiny" style="color:#9ca3af;">
              ä¸å¡«ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯ä¸èƒ½ç®—è·ç¦»
            </span>
          </div>
          <div class="form-inline" style="margin-top: 4px;">
            <span class="subtle-label">å¤‡æ³¨</span>
            <textarea id="input-notes" placeholder="æ’é˜Ÿæ—¶é—´ã€äººå¤šã€å¿…åƒé¡¹ç›®â€¦"></textarea>
          </div>
          <div class="form-inline" style="margin-top: 6px; justify-content: flex-end;">
            <button class="btn btn-sm" id="btn-add-it">
              âœ… æ·»åŠ åˆ°å½“å‰æ—¥æœŸ
            </button>
          </div>
        </div>
      </div>

      <div class="section-divider"></div>

      <div>
        <div class="card-title" style="font-size: 13px; margin-bottom: 4px;">
          <span class="emoji">ğŸ“</span>
          <span>æ”¶è—åœ°ç‚¹ Â· ä¸€é”®åŠ å…¥è¡Œç¨‹</span>
        </div>
        <div class="card-subtitle">
          æå‰æŠŠæƒ³å»çš„åº— / æ™¯ç‚¹å­˜å¥½ï¼Œåˆ°æ—¶å€™ä¸€é”®å¡è¿›æŸä¸€å¤©
        </div>

        <div class="two-column" style="margin-top: 6px;">
          <div>
            <div class="subtle-label">æ–°å¢æ”¶è—åœ°ç‚¹</div>
            <div class="form-inline" style="margin-top: 4px;">
              <span class="subtle-label">åç§°</span>
              <input id="fav-name" type="text" class="long" placeholder="åº—å / æ™¯ç‚¹å" />
            </div>
            <div class="form-inline" style="margin-top: 4px;">
              <span class="subtle-label">ç±»å‹</span>
              <select id="fav-type">
                <option value="food">ç¾é£Ÿ</option>
                <option value="cafe">å’–å•¡</option>
                <option value="poi">æ™¯ç‚¹</option>
                <option value="shopping">è´­ç‰©</option>
                <option value="other">å…¶ä»–</option>
              </select>
              <span class="subtle-label">æ ‡ç­¾</span>
              <input id="fav-tags" type="text" class="medium" placeholder="ä¾‹å¦‚ï¼šMabel æƒ³å»" />
            </div>
            <div class="form-inline" style="margin-top: 4px;">
              <span class="subtle-label">åœ°å€</span>
              <input id="fav-address" type="text" class="long" placeholder="åœ°å€ï¼ˆå¯é€‰ï¼‰" />
            </div>
            <div class="form-inline" style="margin-top: 4px;">
              <span class="subtle-label">åœ°å›¾</span>
              <input id="fav-map" type="text" class="long" placeholder="Google Maps é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
            </div>
            <div class="form-inline" style="margin-top: 4px;">
              <span class="subtle-label">ç»çº¬åº¦</span>
              <input id="fav-lat" type="number" step="0.000001" class="medium" placeholder="lat" />
              <input id="fav-lng" type="number" step="0.000001" class="medium" placeholder="lng" />
            </div>
            <div class="form-inline" style="margin-top: 4px;">
              <span class="subtle-label">å¤‡æ³¨</span>
              <textarea id="fav-notes" placeholder="æ¥è‡ªæŸä¸ª YouTuber / å¿…ç‚¹èœâ€¦"></textarea>
            </div>
            <div class="form-inline" style="margin-top: 6px; justify-content:flex-end;">
              <button class="btn btn-sm btn-outline" id="btn-add-fav">
                â­ åŠ å…¥æ”¶è—
              </button>
            </div>
          </div>

          <div>
            <div class="subtle-label">
              æ”¶è—åˆ—è¡¨ï¼ˆç‚¹å‡»ã€ŒåŠ å…¥è¡Œç¨‹ã€å¿«é€Ÿå¡è¿›æŸä¸€å¤©ï¼‰
            </div>
            <div class="favorites-list scroll-fade" id="favorites-list">
              <!-- æ”¶è—åœ°ç‚¹æ¸²æŸ“ -->
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- å³ä¾§ï¼šæ¸…å• + æ±‡ç‡å·¥å…· -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="emoji">âœ…</span>
            <span>è¡Œå‰ To-do & æ‰“åŒ…æ¸…å•</span>
          </div>
          <div class="card-subtitle">
            è¡Œå‰å‡†å¤‡ + æ‰“åŒ…è®°å¾—å¸¦ä»€ä¹ˆï¼Œéƒ½é›†ä¸­åœ¨è¿™è¾¹
          </div>
        </div>
      </div>

      <div class="two-column">
        <div>
          <div class="card-title" style="font-size: 13px; margin-bottom: 4px;">
            <span class="emoji">ğŸ“‹</span>
            <span>è¡Œå‰å¾…åŠ</span>
          </div>
          <div class="checklist-section" id="checklist-pretrip">
            <!-- è¡Œå‰å¾…åŠæ¸²æŸ“ -->
          </div>
          <div class="form-inline" style="margin-top: 6px;">
            <input id="pretrip-new" type="text" class="long" placeholder="æ–°å¢å¾…åŠï¼Œä¾‹å¦‚ï¼šè´­ä¹°ä¿é™©" />
            <button class="btn btn-sm btn-outline" id="btn-add-pretrip">
              â•
            </button>
          </div>
        </div>

        <div>
          <div class="card-title" style="font-size: 13px; margin-bottom: 4px;">
            <span class="emoji">ğŸ’</span>
            <span>æ‰“åŒ…æ¸…å•</span>
          </div>
          <div class="checklist-section" id="checklist-packing">
            <!-- æ‰“åŒ…æ¸…å•æ¸²æŸ“ -->
          </div>
          <div class="form-inline" style="margin-top: 6px;">
            <input id="packing-new" type="text" class="long" placeholder="æ–°å¢ç‰©å“ï¼Œä¾‹å¦‚ï¼šå……ç”µå™¨" />
            <button class="btn btn-sm btn-outline" id="btn-add-packing">
              â•
            </button>
          </div>
        </div>
      </div>

      <div class="section-divider"></div>

      <div>
        <div class="card-title" style="font-size: 13px; margin-bottom: 4px;">
          <span class="emoji">ğŸ’±</span>
          <span>æ±‡ç‡ & å°æ¢ç®—å™¨</span>
        </div>
        <div class="card-subtitle">
          æ‰‹åŠ¨è¾“å…¥ 1 TWD = ? MYRï¼Œç„¶åè¿™é‡Œå¸®ä½ å¿«é€Ÿæ¢ç®—
        </div>
        <div class="exchange-row">
          <span class="subtle-label">é‡‘é¢</span>
          <input id="fx-amount" type="number" step="0.01" placeholder="TWD" />
          <span id="fx-result" class="exchange-result">= 0 MYR</span>
        </div>
        <div class="small-note">
          æ±‡ç‡ä»…ä¾›å‚è€ƒï¼Œä»¥å®é™…æ‰£æ¬¾ä¸ºå‡†ã€‚ä½ ä¹Ÿå¯ä»¥ç”¨å®ƒä¼°ç®—å¤œå¸‚èŠ±è´¹ã€‚
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // --- æ•°æ®ç»“æ„ & æŒä¹…åŒ– ---

  const STORAGE_KEY = "ustrip_data_v1";

  const defaultData = {
    trip: {
      name: "UsTrip Â· å°æ¹¾æ—…è¡Œ",
      subtitle: "æˆ‘ä»¬çš„å°æ¹¾æ—…è¡Œ",
      startDate: "",
      endDate: "",
      baseCurrency: "MYR",
      localCurrency: "TWD",
      exchangeRate: 0.15
    },
    days: [
      { id: "day1", label: "Day 1", date: "", city: "å°åŒ—", items: [] },
      { id: "day2", label: "Day 2", date: "", city: "å°åŒ—", items: [] },
      { id: "day3", label: "Day 3", date: "", city: "å°åŒ—", items: [] },
      { id: "day4", label: "Day 4", date: "", city: "å°ä¸­", items: [] },
      { id: "day5", label: "Day 5", date: "", city: "å°å—", items: [] },
      { id: "day6", label: "Day 6", date: "", city: "é«˜é›„", items: [] }
    ],
    checklist: [
      { id: "pre1", category: "pretrip", text: "è´­ä¹°æ—…æ¸¸ä¿é™©", done: false },
      { id: "pre2", category: "pretrip", text: "å…‘æ¢å°å¸ç°é‡‘", done: false },
      { id: "pre3", category: "pretrip", text: "ç¡®è®¤æœºç¥¨ & é…’åº—é¢„è®¢ä¿¡æ¯", done: false },
      { id: "pack1", category: "packing", text: "æŠ¤ç…§ & è¯ä»¶å¤å°ä»¶", done: false },
      { id: "pack2", category: "packing", text: "å……ç”µå™¨ / æ’å¤´è½¬æ¢å™¨", done: false },
      { id: "pack3", category: "packing", text: "æ—¥å¸¸è¯ç‰©", done: false }
    ],
    favorites: [
      // ç¤ºä¾‹å¯ä¸ºç©º
    ]
  };

  let data = loadData();
  let currentDayId = data.days[0]?.id || "day1";

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return structuredClone(defaultData);
      const obj = JSON.parse(raw);
      // ç®€å•å®¹é”™ï¼šè¡¥å……ç¼ºå¤±å­—æ®µ
      return {
        trip: { ...defaultData.trip, ...(obj.trip || {}) },
        days: obj.days && obj.days.length ? obj.days : structuredClone(defaultData.days),
        checklist: obj.checklist || structuredClone(defaultData.checklist),
        favorites: obj.favorites || []
      };
    } catch (e) {
      console.warn("load failed, use default", e);
      return structuredClone(defaultData);
    }
  }

  function saveData() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.warn("save failed", e);
    }
  }

  // --- å·¥å…·å‡½æ•° ---

  function uid(prefix) {
    return (
      prefix +
      "_" +
      Date.now().toString(36) +
      "_" +
      Math.random().toString(36).slice(2, 7)
    );
  }

  function getDistanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = deg => (deg * Math.PI) / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function formatKm(km) {
    if (!isFinite(km)) return "";
    if (km < 0.1) return (km * 1000).toFixed(0) + " m";
    return km.toFixed(1) + " km";
  }

  function getCurrentDay() {
    return data.days.find(d => d.id === currentDayId) || data.days[0];
  }

  // --- æ¸²æŸ“å‡½æ•° ---

  function renderHeader() {
    const trip = data.trip;
    const subtitleEl = document.getElementById("trip-subtitle");
    subtitleEl.textContent = trip.subtitle || trip.name || "æˆ‘ä»¬çš„æ—…è¡Œ";

    const exchangeDisplay = document.getElementById("exchange-display");
    exchangeDisplay.textContent = `1 ${trip.localCurrency} â‰ˆ ${trip.exchangeRate.toFixed(
      4
    )} ${trip.baseCurrency}`;
  }

  function renderTripSummary() {
    const trip = data.trip;
    const days = data.days;
    const tripSummary = document.getElementById("trip-summary");

    const dayCount = days.length;
    const datePart =
      trip.startDate && trip.endDate
        ? `${trip.startDate} - ${trip.endDate}`
        : "è¿˜æ²¡è®¾ç½®æ—¥æœŸ";
    tripSummary.textContent = `${datePart} Â· å…± ${dayCount} å¤©`;

    // åŸå¸‚æ¦‚è§ˆ
    const cityOverview = document.getElementById("city-overview");
    cityOverview.innerHTML = "";
    const cityCount = {};
    days.forEach(d => {
      if (!d.city) return;
      cityCount[d.city] = (cityCount[d.city] || 0) + 1;
    });
    Object.entries(cityCount).forEach(([city, count]) => {
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = `${city} Â· ${count} å¤©`;
      cityOverview.appendChild(span);
    });
    if (!Object.keys(cityCount).length) {
      const span = document.createElement("span");
      span.className = "pill pill-muted";
      span.textContent = "ä½ è¿˜æ²¡ç»™æ¯ä¸€å¤©è®¾ç½®åŸå¸‚å™¢";
      cityOverview.appendChild(span);
    }
  }

  function renderDaySelector() {
    const container = document.getElementById("day-selector");
    container.innerHTML = "";
    data.days.forEach(day => {
      const btn = document.createElement("button");
      btn.className = "day-chip" + (day.id === currentDayId ? " active" : "");
      const dateLabel = day.date ? ` Â· ${day.date}` : "";
      btn.textContent = `${day.label}${dateLabel}`;
      btn.addEventListener("click", () => {
        currentDayId = day.id;
        renderAll();
      });
      container.appendChild(btn);
    });
  }

  function renderDaySummary() {
    const summary = document.getElementById("day-summary");
    const day = getCurrentDay();
    if (!day) {
      summary.textContent = "å°šæœªåˆ›å»ºä»»ä½•è¡Œç¨‹æ—¥";
      return;
    }
    const count = day.items.length;
    const dateText = day.date || "æ—¥æœŸæœªè®¾ç½®";
    const cityText = day.city || "åŸå¸‚æœªè®¾ç½®";
    summary.innerHTML = `
      <span><strong>${day.label}</strong> Â· ${dateText} Â· ${cityText}</span>
      <span>å…± <strong>${count}</strong> ä¸ªè¡Œç¨‹ç‚¹</span>
    `;
    const title = document.getElementById("itinerary-title");
    title.textContent = `${day.label} è¡Œç¨‹`;
  }

  function renderItinerary() {
    const listEl = document.getElementById("itinerary-list");
    listEl.innerHTML = "";
    const day = getCurrentDay();
    if (!day) return;

    const items = [...day.items].sort((a, b) => {
      return (a.time || "").localeCompare(b.time || "");
    });

    // è®¡ç®—è¿ç»­è¡Œç¨‹è·ç¦»
    let prevWithGeo = null;
    items.forEach(item => {
      item._distanceFromPrev = null;
      if (
        prevWithGeo &&
        prevWithGeo.lat != null &&
        prevWithGeo.lng != null &&
        item.lat != null &&
        item.lng != null
      ) {
        const km = getDistanceKm(
          Number(prevWithGeo.lat),
          Number(prevWithGeo.lng),
          Number(item.lat),
          Number(item.lng)
        );
        item._distanceFromPrev = km;
      }
      if (item.lat != null && item.lng != null) {
        prevWithGeo = item;
      }
    });

    if (!items.length) {
      const empty = document.createElement("div");
      empty.className = "card-subtitle";
      empty.style.marginTop = "6px";
      empty.textContent = "ä»Šå¤©è¿˜æ²¡æœ‰è¡Œç¨‹ï¼Œä¸‹é¢å…ˆæ·»åŠ ä¸€ä¸ªå§ï½";
      listEl.appendChild(empty);
      return;
    }

    items.forEach(item => {
      const wrapper = document.createElement("div");
      wrapper.className = "it-item";

      const timeEl = document.createElement("div");
      timeEl.className = "it-time";
      timeEl.textContent = item.time || "--:--";

      const main = document.createElement("div");
      main.className = "it-main";

      const titleRow = document.createElement("div");
      titleRow.className = "it-title-row";

      const title = document.createElement("div");
      title.className = "it-title";
      title.textContent = item.title || "(æœªå‘½ååœ°ç‚¹)";

      const tag = document.createElement("div");
      tag.className = "it-tag";
      tag.textContent = typeLabel(item.type);

      titleRow.appendChild(title);
      titleRow.appendChild(tag);

      const sub = document.createElement("div");
      sub.className = "it-sub";
      sub.textContent = item.address || item.notes || "æš‚æ— å¤‡æ³¨";

      const metaRow = document.createElement("div");
      metaRow.className = "it-meta-row";

      if (item._distanceFromPrev != null) {
        const distBadge = document.createElement("span");
        distBadge.className = "badge-distance";
        distBadge.textContent =
          "è·ä¸Šä¸€ç‚¹çº¦ " + formatKm(item._distanceFromPrev);
        metaRow.appendChild(distBadge);
      }

      if (item.lat != null && item.lng != null) {
        const geoMeta = document.createElement("span");
        geoMeta.className = "it-meta";
        geoMeta.textContent = `(${Number(item.lat).toFixed(
          4
        )}, ${Number(item.lng).toFixed(4)})`;
        metaRow.appendChild(geoMeta);
      }

      const actions = document.createElement("div");
      actions.className = "it-actions";

      if (item.mapLink) {
        const mapBtn = document.createElement("button");
        mapBtn.className = "btn btn-sm btn-outline";
        mapBtn.textContent = "åœ°å›¾";
        mapBtn.addEventListener("click", () => {
          window.open(item.mapLink, "_blank");
        });
        actions.appendChild(mapBtn);
      }

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-outline";
      delBtn.textContent = "åˆ é™¤";
      delBtn.addEventListener("click", () => {
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¡Œç¨‹ç‚¹å—ï¼Ÿ")) {
          day.items = day.items.filter(it => it.id !== item.id);
          saveData();
          renderItinerary();
          renderDaySummary();
        }
      });
      actions.appendChild(delBtn);

      metaRow.appendChild(actions);

      main.appendChild(titleRow);
      main.appendChild(sub);
      main.appendChild(metaRow);

      wrapper.appendChild(timeEl);
      wrapper.appendChild(main);

      listEl.appendChild(wrapper);
    });
  }

  function renderChecklist() {
    const preEl = document.getElementById("checklist-pretrip");
    const packEl = document.getElementById("checklist-packing");
    preEl.innerHTML = "";
    packEl.innerHTML = "";

    data.checklist.forEach(item => {
      const container = document.createElement("div");
      container.className = "check-item" + (item.done ? " done" : "");

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = item.done;
      checkbox.addEventListener("change", () => {
        item.done = checkbox.checked;
        saveData();
        renderChecklist();
      });

      const textSpan = document.createElement("span");
      textSpan.className = "text";
      textSpan.textContent = item.text;

      container.appendChild(checkbox);
      container.appendChild(textSpan);

      if (item.category === "pretrip") {
        preEl.appendChild(container);
      } else if (item.category === "packing") {
        packEl.appendChild(container);
      }
    });

    if (!preEl.children.length) {
      preEl.innerHTML =
        '<div class="small-note">è¿˜æ²¡æœ‰è¡Œå‰å¾…åŠï¼Œä¸‹é¢å…ˆåŠ å‡ ä¸ªå§ï½</div>';
    }
    if (!packEl.children.length) {
      packEl.innerHTML =
        '<div class="small-note">è¿˜æ²¡æœ‰æ‰“åŒ…æ¸…å•ï¼Œä¸‹é¢å…ˆåŠ å‡ ä¸ªå§ï½</div>';
    }
  }

  function renderFavorites() {
    const listEl = document.getElementById("favorites-list");
    listEl.innerHTML = "";
    if (!data.favorites.length) {
      const empty = document.createElement("div");
      empty.className = "small-note";
      empty.textContent = "è¿˜æ²¡æœ‰æ”¶è—åœ°ç‚¹ï¼Œå·¦è¾¹å…ˆæ–°å¢å‡ ä¸ªå–œæ¬¢çš„åº— / æ™¯ç‚¹ï½";
      listEl.appendChild(empty);
      return;
    }

    data.favorites.forEach(f => {
      const card = document.createElement("div");
      card.className = "fav-item";

      const header = document.createElement("div");
      header.className = "fav-header";

      const name = document.createElement("div");
      name.className = "fav-name";
      name.textContent = f.name || "(æœªå‘½ååœ°ç‚¹)";

      const typePill = document.createElement("div");
      typePill.className = "fav-type-pill";
      typePill.textContent = favTypeLabel(f.type);

      header.appendChild(name);
      header.appendChild(typePill);

      const sub = document.createElement("div");
      sub.className = "fav-sub";
      sub.textContent = f.address || f.notes || "æš‚æ— å¤‡æ³¨";

      const actions = document.createElement("div");
      actions.className = "fav-actions";

      const addBtn = document.createElement("button");
      addBtn.className = "btn btn-sm";
      addBtn.textContent = "åŠ å…¥è¡Œç¨‹";
      addBtn.addEventListener("click", () => {
        addFavoriteToDayDialog(f);
      });
      actions.appendChild(addBtn);

      if (f.mapLink) {
        const link = document.createElement("a");
        link.href = f.mapLink;
        link.target = "_blank";
        link.className = "muted-link";
        link.textContent = "æ‰“å¼€åœ°å›¾";
        actions.appendChild(link);
      }

      const delBtn = document.createElement("button");
      delBtn.className = "text-link-button";
      delBtn.textContent = "åˆ é™¤";
      delBtn.addEventListener("click", () => {
        if (confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ”¶è—åœ°ç‚¹å—ï¼Ÿ")) {
          data.favorites = data.favorites.filter(x => x.id !== f.id);
          saveData();
          renderFavorites();
        }
      });
      actions.appendChild(delBtn);

      const extra = document.createElement("div");
      extra.className = "small-note";
      let extraText = "";
      if (f.tags && f.tags.length) {
        extraText += "æ ‡ç­¾ï¼š" + f.tags.join("ï¼Œ");
      }
      if (f.lat != null && f.lng != null) {
        if (extraText) extraText += " Â· ";
        extraText += `(${Number(f.lat).toFixed(4)}, ${Number(f.lng).toFixed(
          4
        )})`;
      }
      extra.textContent = extraText;

      card.appendChild(header);
      card.appendChild(sub);
      card.appendChild(actions);
      if (extraText) card.appendChild(extra);

      listEl.appendChild(card);
    });
  }

  function typeLabel(t) {
    switch (t) {
      case "poi":
        return "æ™¯ç‚¹";
      case "food":
        return "ç¾é£Ÿ";
      case "hotel":
        return "ä½å®¿";
      case "transport":
        return "äº¤é€š";
      case "other":
      default:
        return "å…¶ä»–";
    }
  }

  function favTypeLabel(t) {
    switch (t) {
      case "food":
        return "ç¾é£Ÿ";
      case "cafe":
        return "å’–å•¡";
      case "poi":
        return "æ™¯ç‚¹";
      case "shopping":
        return "è´­ç‰©";
      default:
        return "å…¶ä»–";
    }
  }

  function renderAll() {
    renderHeader();
    renderTripSummary();
    renderDaySelector();
    renderDaySummary();
    renderItinerary();
    renderChecklist();
    renderFavorites();
    updateFxCalc();
  }

  // --- äº¤äº’ï¼šæ–°å¢è¡Œç¨‹ ---

  function setupAddItinerary() {
    const btn = document.getElementById("btn-add-it");
    btn.addEventListener("click", () => {
      const time = document.getElementById("input-time").value.trim();
      const type = document.getElementById("input-type").value;
      const title = document.getElementById("input-title").value.trim();
      const address = document.getElementById("input-address").value.trim();
      const mapLink = document.getElementById("input-map").value.trim();
      const latStr = document.getElementById("input-lat").value.trim();
      const lngStr = document.getElementById("input-lng").value.trim();
      const notes = document.getElementById("input-notes").value.trim();

      if (!title) {
        alert("è‡³å°‘å†™ä¸€ä¸ªæ ‡é¢˜ï¼Œä¾‹å¦‚ï¼šè¥¿é—¨ç”º / é¥¶æ²³å¤œå¸‚");
        return;
      }

      const newItem = {
        id: uid("it"),
        time: time || "",
        type,
        title,
        address,
        mapLink: mapLink || "",
        lat: latStr ? Number(latStr) : null,
        lng: lngStr ? Number(lngStr) : null,
        notes
      };

      const day = getCurrentDay();
      day.items.push(newItem);
      saveData();

      // æ¸…ç©ºéƒ¨åˆ†è¾“å…¥
      document.getElementById("input-title").value = "";
      document.getElementById("input-address").value = "";
      document.getElementById("input-map").value = "";
      document.getElementById("input-lat").value = "";
      document.getElementById("input-lng").value = "";
      document.getElementById("input-notes").value = "";

      renderItinerary();
      renderDaySummary();
    });
  }

  // --- äº¤äº’ï¼šæ”¶è—åœ°ç‚¹ ---

  function setupAddFavorite() {
    document
      .getElementById("btn-add-fav")
      .addEventListener("click", () => {
        const name = document.getElementById("fav-name").value.trim();
        const type = document.getElementById("fav-type").value;
        const tagsStr = document.getElementById("fav-tags").value.trim();
        const address = document.getElementById("fav-address").value.trim();
        const mapLink = document.getElementById("fav-map").value.trim();
        const latStr = document.getElementById("fav-lat").value.trim();
        const lngStr = document.getElementById("fav-lng").value.trim();
        const notes = document.getElementById("fav-notes").value.trim();

        if (!name) {
          alert("æ”¶è—åœ°ç‚¹è‡³å°‘éœ€è¦ä¸€ä¸ªåç§°");
          return;
        }

        const fav = {
          id: uid("fav"),
          name,
          type,
          address,
          mapLink: mapLink || "",
          lat: latStr ? Number(latStr) : null,
          lng: lngStr ? Number(lngStr) : null,
          notes,
          tags: tagsStr
            ? tagsStr
                .split(/[ï¼Œ,]/)
                .map(s => s.trim())
                .filter(Boolean)
            : []
        };

        data.favorites.push(fav);
        saveData();

        // æ¸…ç©ºè¡¨å•
        document.getElementById("fav-name").value = "";
        document.getElementById("fav-tags").value = "";
        document.getElementById("fav-address").value = "";
        document.getElementById("fav-map").value = "";
        document.getElementById("fav-lat").value = "";
        document.getElementById("fav-lng").value = "";
        document.getElementById("fav-notes").value = "";

        renderFavorites();
      });
  }

  function addFavoriteToDayDialog(fav) {
    const dayOptions = data.days
      .map(d => `${d.label}${d.date ? " Â· " + d.date : ""}`)
      .join("\n");

    const dayIndexStr = prompt(
      "è¦åŠ åˆ°ç¬¬å‡ å¤©ï¼Ÿ\n" +
        dayOptions
          .split("\n")
          .map((line, idx) => `${idx + 1}. ${line}`)
          .join("\n")
    );
    if (!dayIndexStr) return;
    const idx = Number(dayIndexStr) - 1;
    if (Number.isNaN(idx) || idx < 0 || idx >= data.days.length) {
      alert("æ²¡æœ‰å¯¹åº”çš„å¤©æ•°");
      return;
    }

    const time = prompt("æ—¶é—´ï¼ˆä¾‹å¦‚ 09:30ï¼Œç•™ç©ºä¹Ÿå¯ä»¥ï¼‰", "18:00") || "";

    const targetDay = data.days[idx];
    targetDay.items.push({
      id: uid("it"),
      time,
      type: fav.type === "food" || fav.type === "cafe" ? "food" : "poi",
      title: fav.name,
      address: fav.address,
      mapLink: fav.mapLink,
      lat: fav.lat,
      lng: fav.lng,
      notes: fav.notes || ""
    });

    saveData();
    // å¦‚æœåˆšå¥½æ˜¯å½“å‰ dayï¼Œåˆ·æ–°è¡Œç¨‹
    if (targetDay.id === currentDayId) {
      renderItinerary();
      renderDaySummary();
    }
  }

  // --- äº¤äº’ï¼šæ¸…å• ---

  function setupChecklistAdd() {
    document
      .getElementById("btn-add-pretrip")
      .addEventListener("click", () => {
        const input = document.getElementById("pretrip-new");
        const text = input.value.trim();
        if (!text) return;
        data.checklist.push({
          id: uid("pre"),
          category: "pretrip",
          text,
          done: false
        });
        input.value = "";
        saveData();
        renderChecklist();
      });

    document
      .getElementById("btn-add-packing")
      .addEventListener("click", () => {
        const input = document.getElementById("packing-new");
        const text = input.value.trim();
        if (!text) return;
        data.checklist.push({
          id: uid("pack"),
          category: "packing",
          text,
          done: false
        });
        input.value = "";
        saveData();
        renderChecklist();
      });
  }

  // --- äº¤äº’ï¼šæ±‡ç‡ & æ¢ç®— ---

  function setupExchangeRate() {
    document
      .getElementById("btn-edit-exchange")
      .addEventListener("click", () => {
        const current = data.trip.exchangeRate;
        const input = prompt(
          `è¯·è¾“å…¥ 1 ${data.trip.localCurrency} ç­‰äºå¤šå°‘ ${data.trip.baseCurrency}`,
          String(current)
        );
        if (!input) return;
        const v = Number(input);
        if (!isFinite(v) || v <= 0) {
          alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
          return;
        }
        data.trip.exchangeRate = v;
        saveData();
        renderHeader();
        updateFxCalc();
      });

    document
      .getElementById("fx-amount")
      .addEventListener("input", updateFxCalc);
  }

  function updateFxCalc() {
    const amountEl = document.getElementById("fx-amount");
    const resultEl = document.getElementById("fx-result");
    const amt = Number(amountEl.value);
    const rate = data.trip.exchangeRate;
    if (!amountEl.value || !isFinite(amt)) {
      resultEl.textContent = `= 0 ${data.trip.baseCurrency}`;
      return;
    }
    const converted = amt * rate;
    resultEl.textContent = `â‰ˆ ${converted.toFixed(2)} ${data.trip.baseCurrency}`;
  }

  // --- äº¤äº’ï¼šç¼–è¾‘è¡Œç¨‹ä¿¡æ¯ï¼ˆæ ‡é¢˜ / æ—¥æœŸï¼‰ ---

  function setupTripEdit() {
    document
      .getElementById("btn-edit-trip")
      .addEventListener("click", () => {
        const name = prompt("è¡Œç¨‹åç§°ï¼ˆä¾‹å¦‚ï¼šå°æ¹¾ 6 æ—¥æ¸¸ï¼‰", data.trip.name);
        if (!name) return;
        const subtitle = prompt("å‰¯æ ‡é¢˜ï¼ˆä¼šæ˜¾ç¤ºåœ¨é¡¶éƒ¨ï¼‰", data.trip.subtitle || "");
        const startDate = prompt("å‡ºå‘æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2026-03-01ï¼‰", data.trip.startDate || "");
        const endDate = prompt("ç»“æŸæ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2026-03-06ï¼‰", data.trip.endDate || "");

        data.trip.name = name;
        data.trip.subtitle = subtitle || name;
        data.trip.startDate = startDate || "";
        data.trip.endDate = endDate || "";

        saveData();
        renderHeader();
        renderTripSummary();
      });
  }

  // --- åˆå§‹åŒ– ---

  document.addEventListener("DOMContentLoaded", () => {
    renderAll();
    setupAddItinerary();
    setupAddFavorite();
    setupChecklistAdd();
    setupExchangeRate();
    setupTripEdit();
  });
</script>
</body>
</html>
