<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>UsTrip Â· å°æ¹¾è¡Œç¨‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #fafafa;
      --card: #ffffff;
      --card-soft: #f4f4f5;
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --text: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --radius-lg: 14px;
      --radius-md: 10px;
      --shadow-soft: 0 4px 12px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 10px 10px 72px;
    }

    /* é¡¶éƒ¨ */

    .app-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg);
      padding-bottom: 6px;
    }

    .header-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: var(--card);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: linear-gradient(135deg, #2563eb, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 17px;
      box-shadow: 0 5px 10px rgba(37, 99, 235, 0.5);
    }

    .logo-text-title {
      font-size: 15px;
      font-weight: 700;
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: #1d4ed8;
      font-size: 11px;
    }

    .chip button {
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 4px 9px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #111827;
      color: #f9fafb;
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-sm {
      padding: 3px 8px;
      font-size: 11px;
    }

    main {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .screen {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .screen-active {
      display: flex;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 10px 11px 12px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
    }

    .card-soft {
      background: var(--card-soft);
      border-radius: var(--radius-md);
      padding: 7px 8px;
      border: 1px solid #e4e4e7;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title .emoji { font-size: 16px; }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* æ—¥é€‰æ‹© + æ¦‚è§ˆ */

    .day-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 6px 0 4px;
    }

    .day-chip {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: #e5e7eb;
      color: #4b5563;
      cursor: pointer;
    }

    .day-chip.active {
      background: #2563eb;
      color: #f9fafb;
      border-color: #1d4ed8;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .summary-row span strong { color: var(--text); }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .pill {
      font-size: 10px;
      border-radius: 999px;
      padding: 3px 8px;
      background: #e0f2fe;
      color: #1d4ed8;
    }

    .pill-muted {
      background: #e5e7eb;
      color: #6b7280;
    }

    .section-divider {
      margin: 8px 0 6px;
      height: 1px;
      background: linear-gradient(to right, transparent, #e4e4e7, transparent);
    }

    /* è¡Œç¨‹åˆ—è¡¨ */

    .itinerary-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 330px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .it-item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 6px;
      padding: 7px 8px;
      border-radius: var(--radius-md);
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .it-time {
      font-size: 11px;
      font-weight: 600;
      color: #4b5563;
      min-width: 40px;
      padding-top: 2px;
    }

    .it-main { font-size: 12px; }

    .it-title-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
    }

    .it-title { font-weight: 600; }

    .it-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #dbeafe;
      color: #1e40af;
      white-space: nowrap;
    }

    .it-sub {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .it-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 3px;
      align-items: center;
    }

    .badge-distance {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #0369a1;
    }

    .it-meta {
      font-size: 10px;
      color: #6b7280;
    }

    .it-actions {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }

    /* è¡¨å• */

    .form-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
      align-items: center;
    }

    .form-inline input,
    .form-inline select {
      padding: 4px 7px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      background: #fafafa;
      min-width: 0;
    }

    .form-inline input.short { width: 72px; }
    .form-inline input.medium { width: 110px; }
    .form-inline input.long { flex: 1 1 150px; }

    .form-inline textarea {
      font-size: 11px;
      border-radius: 8px;
      border: 1px solid #d4d4d8;
      padding: 5px 7px;
      width: 100%;
      resize: vertical;
      min-height: 38px;
      background: #fafafa;
    }

    .subtle-label {
      font-size: 10px;
      color: #6b7280;
    }

    /* æ¸…å• */

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    @media (max-width: 420px) {
      .two-column {
        grid-template-columns: 1fr;
      }
    }

    .checklist-section {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      max-height: 250px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .check-item {
      display: flex;
      align-items: flex-start;
      gap: 5px;
      font-size: 11px;
      padding: 5px 7px;
      border-radius: 9px;
      background: #f9fafb;
      border: 1px solid #e4e4e7;
    }

    .check-item.done span.text {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .check-item input[type="checkbox"] {
      margin-top: 1px;
    }

    /* æ”¶è— */

    .favorites-list {
      margin-top: 4px;
      max-height: 320px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-right: 2px;
    }

    .fav-item {
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #e4e4e7;
      background: #f9fafb;
    }

    .fav-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
      margin-bottom: 2px;
    }

    .fav-name { font-weight: 600; }

    .fav-type-pill {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      white-space: nowrap;
    }

    .fav-sub {
      font-size: 10px;
      color: #6b7280;
      margin-bottom: 3px;
    }

    .fav-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .small-note {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .muted-link,
    .text-link-button {
      font-size: 10px;
      color: #4b5563;
      text-decoration: none;
      border-bottom: 1px dashed #d4d4d8;
      background: transparent;
      border-radius: 0;
      border: none;
      padding: 0;
      cursor: pointer;
    }

    .muted-link:hover,
    .text-link-button:hover {
      color: #111827;
    }

    /* æ±‡ç‡ */

    .exchange-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
      font-size: 11px;
    }

    .exchange-row input {
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid #d4d4d8;
      font-size: 11px;
      width: 90px;
      background: #fafafa;
    }

    .exchange-result {
      font-size: 11px;
      color: #4b5563;
    }

    .tiny {
      font-size: 9px;
      color: #9ca3af;
      margin-top: 2px;
    }

    /* åº•éƒ¨å¯¼èˆª */

    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      pointer-events: none;
      z-index: 20;
    }

    .bottom-nav-inner {
      max-width: 480px;
      width: 100%;
      padding: 6px 10px 10px;
      pointer-events: auto;
    }

    .bottom-nav-bar {
      background: #111827;
      border-radius: 16px;
      padding: 6px;
      display: flex;
      justify-content: space-between;
      gap: 4px;
      box-shadow: 0 -4px 12px rgba(15, 23, 42, 0.6);
    }

    .nav-btn {
      flex: 1;
      border-radius: 12px;
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 11px;
      padding: 6px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
    }

    .nav-btn span.icon { font-size: 16px; }
    .nav-btn span.label { font-size: 10px; }

    .nav-btn.active {
      background: #f9fafb;
      color: #111827;
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="header-card">
      <div class="logo">
        <div class="logo-badge">U</div>
        <div>
          <div class="logo-text-title" id="trip-name">UsTrip</div>
          <div class="logo-text-sub" id="trip-subtitle">æˆ‘ä»¬çš„å°æ¹¾æ—…è¡Œ</div>
        </div>
      </div>
      <div class="header-right">
        <div class="chip">
          <span id="exchange-display">1 TWD â‰ˆ 0.1500 MYR</span>
          <button id="btn-edit-exchange" title="ä¿®æ”¹æ±‡ç‡">âœï¸</button>
        </div>
        <button class="btn btn-outline btn-sm" id="btn-edit-trip">è¡Œç¨‹ä¿¡æ¯</button>
      </div>
    </div>
  </header>

  <main id="screen-container">
    <!-- è¡Œç¨‹ -->
    <section class="screen screen-active" data-screen="itinerary">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="emoji">ğŸ—ºï¸</span>
              <span>è¡Œç¨‹æ€»è§ˆ</span>
            </div>
            <div class="card-subtitle" id="trip-summary">è¿˜æ²¡è®¾ç½®æ—¥æœŸ Â· å…± 0 å¤©</div>
            <div class="pill-row" id="city-overview"></div>
          </div>
        </div>

        <div class="card-soft">
          <div class="card-subtitle" style="margin-bottom:4px;">é€‰æ‹©è¦æŸ¥çœ‹çš„æ—¥ç¨‹ï¼š</div>
          <div class="day-selector" id="day-selector"></div>
          <div class="summary-row" id="day-summary"></div>
        </div>

        <div class="section-divider"></div>

        <div>
          <div class="card-title" style="font-size:13px;margin-bottom:2px;">
            <span class="emoji">ğŸ“…</span>
            <span id="itinerary-title">ä»Šæ—¥è¡Œç¨‹</span>
          </div>
          <div class="card-subtitle">
            åŒä¸€å¤©è¿ç»­åœ°ç‚¹æœ‰ç»çº¬åº¦æ—¶ï¼Œä¼šæ˜¾ç¤ºã€Œè·ä¸Šä¸€ç‚¹çº¦ X kmã€ï¼›ç‚¹å‡»ã€Œåœ°å›¾ã€æ‰“å¼€ Google Mapsã€‚
          </div>
          <div class="itinerary-list" id="itinerary-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title" style="font-size:13px;margin-bottom:2px;">
          <span class="emoji">â•</span>
          <span>æ–°å¢è¡Œç¨‹é¡¹ç›®ï¼ˆå½“å‰ Dayï¼‰</span>
        </div>
        <div class="card-subtitle">æ—¶é—´ã€ç±»å‹ã€æ ‡é¢˜å¿…å¡«ï¼Œç»çº¬åº¦å¯é€‰ã€‚</div>

        <div class="form-inline" style="margin-top:4px;">
          <span class="subtle-label">æ—¶é—´</span>
          <input id="input-time" type="time" class="short" />
          <span class="subtle-label">ç±»å‹</span>
          <select id="input-type">
            <option value="poi">æ™¯ç‚¹</option>
            <option value="food">ç¾é£Ÿ</option>
            <option value="hotel">ä½å®¿</option>
            <option value="transport">äº¤é€š</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-inline">
          <span class="subtle-label">æ ‡é¢˜</span>
          <input id="input-title" type="text" class="long" placeholder="ä¾‹å¦‚ï¼šè¥¿é—¨ç”º / é¥¶æ²³å¤œå¸‚" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">åœ°å€</span>
          <input id="input-address" type="text" class="long" placeholder="å¯é€‰ï¼Œæ–¹ä¾¿è®¤åœ°ç‚¹" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">åœ°å›¾</span>
          <input id="input-map" type="text" class="long" placeholder="ç²˜è´´ Google Maps é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">ç»çº¬åº¦</span>
          <input id="input-lat" type="number" step="0.000001" class="medium" placeholder="lat" />
          <input id="input-lng" type="number" step="0.000001" class="medium" placeholder="lng" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">å¤‡æ³¨</span>
          <textarea id="input-notes" placeholder="æ’é˜Ÿæ—¶é—´ã€äººå¤šã€å¿…ç‚¹é¡¹ç›®â€¦"></textarea>
        </div>

        <div class="form-inline" style="margin-top:6px;justify-content:flex-end;">
          <button class="btn btn-sm" id="btn-add-it">æ·»åŠ åˆ°å½“å‰æ—¥æœŸ</button>
        </div>
      </div>
    </section>

    <!-- æ”¶è— -->
    <section class="screen" data-screen="favorites">
      <div class="card">
        <div class="card-title" style="margin-bottom:2px;">
          <span class="emoji">ğŸ“</span>
          <span>æ”¶è—åœ°ç‚¹ Â· æ„¿æœ›æ¸…å•</span>
        </div>
        <div class="card-subtitle">
          æŠŠ YouTubeã€IG ä¸Šçœ‹åˆ°æƒ³å»çš„åº—å…ˆæ”¶è—ï¼Œä¹‹åå¡è¿›æŸä¸€å¤©è¡Œç¨‹å³å¯ã€‚
        </div>
        <div class="favorites-list" id="favorites-list"></div>
      </div>

      <div class="card">
        <div class="card-title" style="font-size:13px;margin-bottom:2px;">
          <span class="emoji">â•</span>
          <span>æ–°å¢æ”¶è—åœ°ç‚¹</span>
        </div>

        <div class="form-inline" style="margin-top:4px;">
          <span class="subtle-label">åç§°</span>
          <input id="fav-name" type="text" class="long" placeholder="åº—å / æ™¯ç‚¹å" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">ç±»å‹</span>
          <select id="fav-type">
            <option value="food">ç¾é£Ÿ</option>
            <option value="cafe">å’–å•¡</option>
            <option value="poi">æ™¯ç‚¹</option>
            <option value="shopping">è´­ç‰©</option>
            <option value="other">å…¶ä»–</option>
          </select>
          <span class="subtle-label">æ ‡ç­¾</span>
          <input id="fav-tags" type="text" class="medium" placeholder="ä¾‹å¦‚ï¼šMabel æƒ³å»" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">åœ°å€</span>
          <input id="fav-address" type="text" class="long" placeholder="å¯é€‰" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">åœ°å›¾</span>
          <input id="fav-map" type="text" class="long" placeholder="Google Maps é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">ç»çº¬åº¦</span>
          <input id="fav-lat" type="number" step="0.000001" class="medium" placeholder="lat" />
          <input id="fav-lng" type="number" step="0.000001" class="medium" placeholder="lng" />
        </div>

        <div class="form-inline">
          <span class="subtle-label">å¤‡æ³¨</span>
          <textarea id="fav-notes" placeholder="å“ªä½ YouTuber æ¨èã€å¿…ç‚¹èœâ€¦"></textarea>
        </div>

        <div class="form-inline" style="margin-top:6px;justify-content:flex-end;">
          <button class="btn btn-sm btn-outline" id="btn-add-fav">åŠ å…¥æ”¶è—</button>
        </div>
      </div>
    </section>

    <!-- æ¸…å• -->
    <section class="screen" data-screen="checklist">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="emoji">âœ…</span>
              <span>è¡Œå‰å¾…åŠ & æ‰“åŒ…æ¸…å•</span>
            </div>
            <div class="card-subtitle">æŠŠè„‘è¢‹é‡Œçš„ä¸œè¥¿éƒ½å€’å‡ºæ¥å†™åœ¨è¿™é‡Œï¼Œå®‰å¿ƒå¾ˆå¤šã€‚</div>
          </div>
        </div>

        <div class="two-column">
          <div>
            <div class="card-title" style="font-size:13px;margin-bottom:2px;">
              <span class="emoji">ğŸ“‹</span>
              <span>è¡Œå‰å¾…åŠ</span>
            </div>
            <div class="checklist-section" id="checklist-pretrip"></div>
            <div class="form-inline" style="margin-top:6px;">
              <input id="pretrip-new" type="text" class="long" placeholder="æ–°å¢å¾…åŠï¼Œä¾‹å¦‚ï¼šè´­ä¹°ä¿é™©" />
              <button class="btn btn-sm btn-outline" id="btn-add-pretrip">â•</button>
            </div>
          </div>

          <div>
            <div class="card-title" style="font-size:13px;margin-bottom:2px;">
              <span class="emoji">ğŸ’</span>
              <span>æ‰“åŒ…æ¸…å•</span>
            </div>
            <div class="checklist-section" id="checklist-packing"></div>
            <div class="form-inline" style="margin-top:6px;">
              <input id="packing-new" type="text" class="long" placeholder="æ–°å¢ç‰©å“ï¼Œä¾‹å¦‚ï¼šå……ç”µå™¨" />
              <button class="btn btn-sm btn-outline" id="btn-add-packing">â•</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- æ±‡ç‡ -->
    <section class="screen" data-screen="fx">
      <div class="card">
        <div class="card-title" style="margin-bottom:2px;">
          <span class="emoji">ğŸ’±</span>
          <span>æ±‡ç‡ & å°æ¢ç®—å™¨</span>
        </div>
        <div class="card-subtitle">
          å¤œå¸‚ç°åœºç”¨ï¼šè¾“å…¥å°å¸é‡‘é¢ï¼Œå¤§æ¦‚çŸ¥é“èŠ±äº†å¤šå°‘é©¬å¸ã€‚
        </div>

        <div class="exchange-row">
          <span class="subtle-label">é‡‘é¢</span>
          <input id="fx-amount" type="number" step="0.01" placeholder="TWD" />
          <span id="fx-result" class="exchange-result">= 0 MYR</span>
        </div>

        <div class="section-divider"></div>
        <div class="tiny">
          æ±‡ç‡ä¸ºæ‰‹åŠ¨è¾“å…¥ï¼Œä»…åšä¼°ç®—ä½¿ç”¨ï¼›ä»¥å®é™…åˆ·å¡ / æ‰£æ¬¾ç»“æœä¸ºå‡†ã€‚
        </div>
      </div>
    </section>
  </main>
</div>

<!-- åº•éƒ¨å¯¼èˆª -->
<nav class="bottom-nav">
  <div class="bottom-nav-inner">
    <div class="bottom-nav-bar">
      <button class="nav-btn active" data-target="itinerary">
        <span class="icon">ğŸ“…</span>
        <span class="label">è¡Œç¨‹</span>
      </button>
      <button class="nav-btn" data-target="favorites">
        <span class="icon">ğŸ“</span>
        <span class="label">æ”¶è—</span>
      </button>
      <button class="nav-btn" data-target="checklist">
        <span class="icon">âœ…</span>
        <span class="label">æ¸…å•</span>
      </button>
      <button class="nav-btn" data-target="fx">
        <span class="icon">ğŸ’±</span>
        <span class="label">æ±‡ç‡</span>
      </button>
    </div>
  </div>
</nav>

<script>
  // ===== æ•°æ®ä¸å·¥å…· =====
  const STORAGE_KEY = "ustrip_ustrip_v2";

  const defaultData = {
    trip: {
      name: "UsTrip å°æ¹¾æ—…è¡Œ",
      subtitle: "æˆ‘ä»¬çš„å°æ¹¾æ—…è¡Œ",
      startDate: "",
      endDate: "",
      baseCurrency: "MYR",
      localCurrency: "TWD",
      exchangeRate: 0.15
    },
    days: [
      { id: "day1", label: "Day 1", date: "", city: "å°åŒ—", items: [] },
      { id: "day2", label: "Day 2", date: "", city: "å°åŒ—", items: [] },
      { id: "day3", label: "Day 3", date: "", city: "å°åŒ—", items: [] },
      { id: "day4", label: "Day 4", date: "", city: "å°ä¸­", items: [] },
      { id: "day5", label: "Day 5", date: "", city: "å°å—", items: [] },
      { id: "day6", label: "Day 6", date: "", city: "é«˜é›„", items: [] }
    ],
    checklist: [
      { id: "pre1", category: "pretrip", text: "è´­ä¹°æ—…æ¸¸ä¿é™©", done: false },
      { id: "pre2", category: "pretrip", text: "å…‘æ¢å°å¸ç°é‡‘", done: false },
      { id: "pre3", category: "pretrip", text: "ç¡®è®¤æœºç¥¨ & é…’åº—è®¢å•", done: false },
      { id: "pack1", category: "packing", text: "æŠ¤ç…§ & è¯ä»¶å¤å°ä»¶", done: false },
      { id: "pack2", category: "packing", text: "å……ç”µå™¨ / æ’å¤´è½¬æ¢å™¨", done: false },
      { id: "pack3", category: "packing", text: "æ—¥å¸¸è¯ç‰©", done: false }
    ],
    favorites: []
  };

  function deepClone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return deepClone(defaultData);
      const parsed = JSON.parse(raw);
      return {
        trip: { ...defaultData.trip, ...(parsed.trip || {}) },
        days: parsed.days && parsed.days.length ? parsed.days : deepClone(defaultData.days),
        checklist: parsed.checklist || deepClone(defaultData.checklist),
        favorites: parsed.favorites || []
      };
    } catch (e) {
      console.warn("load failed, use default", e);
      return deepClone(defaultData);
    }
  }

  function saveData() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.warn("save failed", e);
    }
  }

  function uid(prefix) {
    return prefix + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 6);
  }

  function getDistanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = d => (d * Math.PI) / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function formatKm(km) {
    if (!isFinite(km)) return "";
    if (km < 0.1) return (km * 1000).toFixed(0) + " m";
    return km.toFixed(1) + " km";
  }

  function typeLabel(t) {
    switch (t) {
      case "poi": return "æ™¯ç‚¹";
      case "food": return "ç¾é£Ÿ";
      case "hotel": return "ä½å®¿";
      case "transport": return "äº¤é€š";
      default: return "å…¶ä»–";
    }
  }

  function favTypeLabel(t) {
    switch (t) {
      case "food": return "ç¾é£Ÿ";
      case "cafe": return "å’–å•¡";
      case "poi": return "æ™¯ç‚¹";
      case "shopping": return "è´­ç‰©";
      default: return "å…¶ä»–";
    }
  }

  // å…¨å±€çŠ¶æ€
  let data = loadData();
  let currentDayId = data.days[0]?.id || "day1";

  // ===== æ¸²æŸ“å¤´éƒ¨ & è¡Œç¨‹ä¿¡æ¯ =====

  function renderHeader() {
    const t = data.trip;
    document.getElementById("trip-name").textContent = t.name || "UsTrip";
    document.getElementById("trip-subtitle").textContent = t.subtitle || "æˆ‘ä»¬çš„æ—…è¡Œ";
    document.getElementById("exchange-display").textContent =
      `1 ${t.localCurrency} â‰ˆ ${t.exchangeRate.toFixed(4)} ${t.baseCurrency}`;
  }

  function renderTripSummary() {
    const t = data.trip;
    const days = data.days;
    const dayCount = days.length;
    const dateText =
      t.startDate && t.endDate ? `${t.startDate} - ${t.endDate}` : "è¿˜æ²¡è®¾ç½®æ—¥æœŸ";
    document.getElementById("trip-summary").textContent =
      `${dateText} Â· å…± ${dayCount} å¤©`;

    const cityOverview = document.getElementById("city-overview");
    cityOverview.innerHTML = "";
    const cityCount = {};
    days.forEach(d => {
      if (!d.city) return;
      cityCount[d.city] = (cityCount[d.city] || 0) + 1;
    });
    const entries = Object.entries(cityCount);
    if (!entries.length) {
      const span = document.createElement("span");
      span.className = "pill pill-muted";
      span.textContent = "è¿˜æ²¡ä¸ºæ¯å¤©æ ‡è®°åŸå¸‚";
      cityOverview.appendChild(span);
    } else {
      entries.forEach(([city, count]) => {
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = `${city} Â· ${count} å¤©`;
        cityOverview.appendChild(span);
      });
    }
  }

  function getCurrentDay() {
    return data.days.find(d => d.id === currentDayId) || data.days[0];
  }

  function renderDaySelector() {
    const container = document.getElementById("day-selector");
    container.innerHTML = "";
    data.days.forEach(day => {
      const btn = document.createElement("button");
      btn.className = "day-chip" + (day.id === currentDayId ? " active" : "");
      const dateLabel = day.date ? ` Â· ${day.date}` : "";
      btn.textContent = `${day.label}${dateLabel}`;
      btn.addEventListener("click", () => {
        currentDayId = day.id;
        renderDaySummary();
        renderItinerary();
      });
      container.appendChild(btn);
    });
  }

  function renderDaySummary() {
    const summary = document.getElementById("day-summary");
    const day = getCurrentDay();
    if (!day) {
      summary.innerHTML = '<span>å°šæœªåˆ›å»ºè¡Œç¨‹æ—¥</span>';
      return;
    }
    const dateText = day.date || "æ—¥æœŸæœªè®¾ç½®";
    const cityText = day.city || "åŸå¸‚æœªè®¾ç½®";
    const count = day.items.length;
    summary.innerHTML =
      `<span><strong>${day.label}</strong> Â· ${dateText} Â· ${cityText}</span>` +
      `<span>å…± <strong>${count}</strong> ä¸ªè¡Œç¨‹ç‚¹</span>`;
    document.getElementById("itinerary-title").textContent = `${day.label} è¡Œç¨‹`;
  }

  // ===== æ¸²æŸ“è¡Œç¨‹æ—¶é—´è½´ =====

  function renderItinerary() {
    const listEl = document.getElementById("itinerary-list");
    listEl.innerHTML = "";
    const day = getCurrentDay();
    if (!day) return;

    const items = [...day.items].sort((a, b) =>
      (a.time || "").localeCompare(b.time || "")
    );

    if (!items.length) {
      const empty = document.createElement("div");
      empty.className = "card-subtitle";
      empty.style.marginTop = "4px";
      empty.textContent = "ä»Šå¤©è¿˜æ²¡æœ‰è¡Œç¨‹ï¼Œå¯ä»¥ä»ä¸‹æ–¹æˆ–ã€Œæ”¶è—åœ°ç‚¹ã€å¼€å§‹æ·»åŠ ã€‚";
      listEl.appendChild(empty);
      return;
    }

    // è®¡ç®—è¿ç»­å¸¦ç»çº¬åº¦çš„è·ç¦»
    let prevGeo = null;
    items.forEach(it => {
      it._distanceFromPrev = null;
      if (
        prevGeo &&
        prevGeo.lat != null &&
        prevGeo.lng != null &&
        it.lat != null &&
        it.lng != null
      ) {
        it._distanceFromPrev = getDistanceKm(
          Number(prevGeo.lat),
          Number(prevGeo.lng),
          Number(it.lat),
          Number(it.lng)
        );
      }
      if (it.lat != null && it.lng != null) prevGeo = it;
    });

    items.forEach(item => {
      const row = document.createElement("div");
      row.className = "it-item";

      const timeEl = document.createElement("div");
      timeEl.className = "it-time";
      timeEl.textContent = item.time || "--:--";

      const main = document.createElement("div");
      main.className = "it-main";

      const titleRow = document.createElement("div");
      titleRow.className = "it-title-row";

      const title = document.createElement("div");
      title.className = "it-title";
      title.textContent = item.title || "(æœªå‘½ååœ°ç‚¹)";

      const tag = document.createElement("div");
      tag.className = "it-tag";
      tag.textContent = typeLabel(item.type);

      titleRow.appendChild(title);
      titleRow.appendChild(tag);

      const sub = document.createElement("div");
      sub.className = "it-sub";
      sub.textContent = item.address || item.notes || "æš‚æ— å¤‡æ³¨";

      const metaRow = document.createElement("div");
      metaRow.className = "it-meta-row";

      if (item._distanceFromPrev != null) {
        const dist = document.createElement("span");
        dist.className = "badge-distance";
        dist.textContent = "è·ä¸Šä¸€ç‚¹çº¦ " + formatKm(item._distanceFromPrev);
        metaRow.appendChild(dist);
      }

      if (item.lat != null && item.lng != null) {
        const geo = document.createElement("span");
        geo.className = "it-meta";
        geo.textContent = `(${Number(item.lat).toFixed(4)}, ${Number(item.lng).toFixed(4)})`;
        metaRow.appendChild(geo);
      }

      const actions = document.createElement("div");
      actions.className = "it-actions";

      if (item.mapLink) {
        const mapBtn = document.createElement("button");
        mapBtn.className = "btn btn-sm btn-outline";
        mapBtn.textContent = "åœ°å›¾";
        mapBtn.addEventListener("click", () => {
          window.open(item.mapLink, "_blank");
        });
        actions.appendChild(mapBtn);
      }

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-outline";
      delBtn.textContent = "åˆ é™¤";
      delBtn.addEventListener("click", () => {
        if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªè¡Œç¨‹ç‚¹å—ï¼Ÿ")) return;
        day.items = day.items.filter(it => it.id !== item.id);
        saveData();
        renderDaySummary();
        renderItinerary();
      });
      actions.appendChild(delBtn);

      metaRow.appendChild(actions);

      main.appendChild(titleRow);
      main.appendChild(sub);
      main.appendChild(metaRow);

      row.appendChild(timeEl);
      row.appendChild(main);
      listEl.appendChild(row);
    });
  }

  // ===== æ¸²æŸ“æ¸…å• =====

  function renderChecklist() {
    const preEl = document.getElementById("checklist-pretrip");
    const packEl = document.getElementById("checklist-packing");
    preEl.innerHTML = "";
    packEl.innerHTML = "";

    data.checklist.forEach(item => {
      const box = document.createElement("div");
      box.className = "check-item" + (item.done ? " done" : "");

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = item.done;
      checkbox.addEventListener("change", () => {
        item.done = checkbox.checked;
        saveData();
        renderChecklist();
      });

      const text = document.createElement("span");
      text.className = "text";
      text.textContent = item.text;

      box.appendChild(checkbox);
      box.appendChild(text);

      if (item.category === "pretrip") {
        preEl.appendChild(box);
      } else if (item.category === "packing") {
        packEl.appendChild(box);
      }
    });

    if (!preEl.children.length) {
      preEl.innerHTML = '<div class="small-note">è¿˜æ²¡æœ‰è¡Œå‰å¾…åŠï¼Œå¯ä»¥åœ¨ä¸‹æ–¹æ–°å¢ã€‚</div>';
    }
    if (!packEl.children.length) {
      packEl.innerHTML = '<div class="small-note">è¿˜æ²¡æœ‰æ‰“åŒ…æ¸…å•ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹æ–°å¢ã€‚</div>';
    }
  }

  // ===== æ¸²æŸ“æ”¶è— =====

  function renderFavorites() {
    const listEl = document.getElementById("favorites-list");
    listEl.innerHTML = "";
    if (!data.favorites.length) {
      const empty = document.createElement("div");
      empty.className = "small-note";
      empty.textContent = "è¿˜æ²¡æœ‰æ”¶è—åœ°ç‚¹ï¼Œå…ˆæŠŠæƒ³å»çš„åœ°æ–¹å­˜èµ·æ¥å§ï½";
      listEl.appendChild(empty);
      return;
    }

    data.favorites.forEach(f => {
      const card = document.createElement("div");
      card.className = "fav-item";

      const header = document.createElement("div");
      header.className = "fav-header";

      const name = document.createElement("div");
      name.className = "fav-name";
      name.textContent = f.name || "(æœªå‘½ååœ°ç‚¹)";

      const typePill = document.createElement("div");
      typePill.className = "fav-type-pill";
      typePill.textContent = favTypeLabel(f.type);

      header.appendChild(name);
      header.appendChild(typePill);

      const sub = document.createElement("div");
      sub.className = "fav-sub";
      sub.textContent = f.address || f.notes || "æš‚æ— å¤‡æ³¨";

      const actions = document.createElement("div");
      actions.className = "fav-actions";

      const addBtn = document.createElement("button");
      addBtn.className = "btn btn-sm";
      addBtn.textContent = "åŠ å…¥è¡Œç¨‹";
      addBtn.addEventListener("click", () => addFavoriteToDay(f));
      actions.appendChild(addBtn);

      if (f.mapLink) {
        const link = document.createElement("a");
        link.href = f.mapLink;
        link.target = "_blank";
        link.className = "muted-link";
        link.textContent = "æ‰“å¼€åœ°å›¾";
        actions.appendChild(link);
      }

      const delBtn = document.createElement("button");
      delBtn.className = "text-link-button";
      delBtn.textContent = "åˆ é™¤";
      delBtn.addEventListener("click", () => {
        if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ”¶è—å—ï¼Ÿ")) return;
        data.favorites = data.favorites.filter(x => x.id !== f.id);
        saveData();
        renderFavorites();
      });
      actions.appendChild(delBtn);

      const extra = document.createElement("div");
      extra.className = "small-note";
      const tags = f.tags && f.tags.length ? "æ ‡ç­¾ï¼š" + f.tags.join("ï¼Œ") : "";
      const geo =
        f.lat != null && f.lng != null
          ? `(${Number(f.lat).toFixed(4)}, ${Number(f.lng).toFixed(4)})`
          : "";
      extra.textContent = [tags, geo].filter(Boolean).join(" Â· ");

      card.appendChild(header);
      card.appendChild(sub);
      card.appendChild(actions);
      if (extra.textContent) card.appendChild(extra);

      listEl.appendChild(card);
    });
  }

  // ===== æ±‡ç‡æ¢ç®— =====

  function updateFxCalc() {
    const amountEl = document.getElementById("fx-amount");
    const resultEl = document.getElementById("fx-result");
    const amt = Number(amountEl.value);
    const rate = data.trip.exchangeRate;
    if (!amountEl.value || !isFinite(amt)) {
      resultEl.textContent = `= 0 ${data.trip.baseCurrency}`;
      return;
    }
    const converted = amt * rate;
    resultEl.textContent = `â‰ˆ ${converted.toFixed(2)} ${data.trip.baseCurrency}`;
  }

  // ===== äº¤äº’ï¼šæ–°å¢è¡Œç¨‹ =====

  function setupAddItinerary() {
    document.getElementById("btn-add-it").addEventListener("click", () => {
      const time = document.getElementById("input-time").value.trim();
      const type = document.getElementById("input-type").value;
      const title = document.getElementById("input-title").value.trim();
      const address = document.getElementById("input-address").value.trim();
      const mapLink = document.getElementById("input-map").value.trim();
      const latStr = document.getElementById("input-lat").value.trim();
      const lngStr = document.getElementById("input-lng").value.trim();
      const notes = document.getElementById("input-notes").value.trim();

      if (!title) {
        alert("è‡³å°‘å†™ä¸€ä¸ªæ ‡é¢˜ï¼Œä¾‹å¦‚ï¼šè¥¿é—¨ç”º / é¥¶æ²³å¤œå¸‚");
        return;
      }

      const day = getCurrentDay();
      day.items.push({
        id: uid("it"),
        time: time || "",
        type,
        title,
        address,
        mapLink: mapLink || "",
        lat: latStr ? Number(latStr) : null,
        lng: lngStr ? Number(lngStr) : null,
        notes
      });

      // æ¸…ç©ºè¾“å…¥
      document.getElementById("input-title").value = "";
      document.getElementById("input-address").value = "";
      document.getElementById("input-map").value = "";
      document.getElementById("input-lat").value = "";
      document.getElementById("input-lng").value = "";
      document.getElementById("input-notes").value = "";

      saveData();
      renderDaySummary();
      renderItinerary();
    });
  }

  // ===== äº¤äº’ï¼šæ”¶è—åœ°ç‚¹ =====

  function setupAddFavorite() {
    document.getElementById("btn-add-fav").addEventListener("click", () => {
      const name = document.getElementById("fav-name").value.trim();
      const type = document.getElementById("fav-type").value;
      const tagsStr = document.getElementById("fav-tags").value.trim();
      const address = document.getElementById("fav-address").value.trim();
      const mapLink = document.getElementById("fav-map").value.trim();
      const latStr = document.getElementById("fav-lat").value.trim();
      const lngStr = document.getElementById("fav-lng").value.trim();
      const notes = document.getElementById("fav-notes").value.trim();

      if (!name) {
        alert("æ”¶è—åœ°ç‚¹è‡³å°‘éœ€è¦ä¸€ä¸ªåç§°");
        return;
      }

      const fav = {
        id: uid("fav"),
        name,
        type,
        address,
        mapLink: mapLink || "",
        lat: latStr ? Number(latStr) : null,
        lng: lngStr ? Number(lngStr) : null,
        notes,
        tags: tagsStr
          ? tagsStr.split(/[ï¼Œ,]/).map(s => s.trim()).filter(Boolean)
          : []
      };

      data.favorites.push(fav);
      saveData();

      // æ¸…ç©º
      document.getElementById("fav-name").value = "";
      document.getElementById("fav-tags").value = "";
      document.getElementById("fav-address").value = "";
      document.getElementById("fav-map").value = "";
      document.getElementById("fav-lat").value = "";
      document.getElementById("fav-lng").value = "";
      document.getElementById("fav-notes").value = "";

      renderFavorites();
    });
  }

  function addFavoriteToDay(fav) {
    const options = data.days
      .map((d, idx) => `${idx + 1}. ${d.label}${d.date ? " Â· " + d.date : ""}`)
      .join("\n");
    const choice = prompt("è¦åŠ å…¥å“ªä¸€å¤©ï¼Ÿ\n" + options);
    if (!choice) return;
    const idx = Number(choice) - 1;
    if (Number.isNaN(idx) || idx < 0 || idx >= data.days.length) {
      alert("æ²¡æœ‰è¿™ä¸€å¤©");
      return;
    }
    const time = prompt("æ—¶é—´ï¼ˆä¾‹å¦‚ 09:30ï¼Œç•™ç©ºä¹Ÿå¯ä»¥ï¼‰", "18:00") || "";
    const target = data.days[idx];

    target.items.push({
      id: uid("it"),
      time,
      type: fav.type === "food" || fav.type === "cafe" ? "food" : "poi",
      title: fav.name,
      address: fav.address,
      mapLink: fav.mapLink,
      lat: fav.lat,
      lng: fav.lng,
      notes: fav.notes || ""
    });

    saveData();
    if (target.id === currentDayId) {
      renderDaySummary();
      renderItinerary();
    }
  }

  // ===== äº¤äº’ï¼šæ¸…å• =====

  function setupChecklist() {
    document.getElementById("btn-add-pretrip").addEventListener("click", () => {
      const input = document.getElementById("pretrip-new");
      const text = input.value.trim();
      if (!text) return;
      data.checklist.push({
        id: uid("pre"),
        category: "pretrip",
        text,
        done: false
      });
      input.value = "";
      saveData();
      renderChecklist();
    });

    document.getElementById("btn-add-packing").addEventListener("click", () => {
      const input = document.getElementById("packing-new");
      const text = input.value.trim();
      if (!text) return;
      data.checklist.push({
        id: uid("pack"),
        category: "packing",
        text,
        done: false
      });
      input.value = "";
      saveData();
      renderChecklist();
    });
  }

  // ===== äº¤äº’ï¼šæ±‡ç‡ & è¡Œç¨‹ä¿¡æ¯ =====

  function setupExchange() {
    document.getElementById("btn-edit-exchange").addEventListener("click", () => {
      const t = data.trip;
      const input = prompt(
        `è¯·è¾“å…¥ 1 ${t.localCurrency} ç­‰äºå¤šå°‘ ${t.baseCurrency}`,
        String(t.exchangeRate)
      );
      if (!input) return;
      const v = Number(input);
      if (!isFinite(v) || v <= 0) {
        alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—");
        return;
      }
      data.trip.exchangeRate = v;
      saveData();
      renderHeader();
      updateFxCalc();
    });

    const fxAmount = document.getElementById("fx-amount");
    fxAmount.addEventListener("input", updateFxCalc);
  }

  function setupTripEdit() {
    document.getElementById("btn-edit-trip").addEventListener("click", () => {
      const t = data.trip;
      const name = prompt("è¡Œç¨‹åç§°ï¼ˆä¾‹å¦‚ï¼šå°æ¹¾ 6 æ—¥æ¸¸ï¼‰", t.name);
      if (!name) return;
      const subtitle = prompt("å‰¯æ ‡é¢˜ï¼ˆæ˜¾ç¤ºåœ¨é¡¶éƒ¨ï¼‰", t.subtitle || "");
      const startDate = prompt("å‡ºå‘æ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2026-03-01ï¼‰", t.startDate || "");
      const endDate = prompt("ç»“æŸæ—¥æœŸï¼ˆä¾‹å¦‚ï¼š2026-03-06ï¼‰", t.endDate || "");

      t.name = name;
      t.subtitle = subtitle || name;
      t.startDate = startDate || "";
      t.endDate = endDate || "";

      saveData();
      renderHeader();
      renderTripSummary();
    });
  }

  // ===== åº•éƒ¨å¯¼èˆª =====

  function setupBottomNav() {
    const buttons = document.querySelectorAll(".nav-btn");
    const screens = document.querySelectorAll(".screen");
    buttons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");
        buttons.forEach(b => b.classList.toggle("active", b === btn));
        screens.forEach(s => {
          s.classList.toggle("screen-active", s.getAttribute("data-screen") === target);
        });
      });
    });
  }

  // ===== åˆå§‹åŒ– =====

  function renderAll() {
    renderHeader();
    renderTripSummary();
    renderDaySelector();
    renderDaySummary();
    renderItinerary();
    renderChecklist();
    renderFavorites();
    updateFxCalc();
  }

  document.addEventListener("DOMContentLoaded", () => {
    setupBottomNav();
    setupAddItinerary();
    setupAddFavorite();
    setupChecklist();
    setupExchange();
    setupTripEdit();
    renderAll();
  });
</script>
</body>
</html>